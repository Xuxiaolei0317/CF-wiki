<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模块解锁状态转换工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        .modules {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .module {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .module.locked {
            background-color: #ffcccc;
        }
        .module.unlocked {
            background-color: #ccffcc;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>模块解锁状态转换工具</h1>
        
        <div class="input-group">
            <label for="byteInput">初始字节序列:</label>
            <input type="text" id="byteInput" placeholder="如: \xff\x01\x00" value="\x00\x00\x00">
        </div>
        
        <div class="input-group">
            <label for="moduleIndex">模块索引 (0-8):</label>
            <input type="number" id="moduleIndex" min="0" max="8" value="0">
        </div>
        
        <div class="input-group">
            <button id="unlockBtn">解锁模块</button>
            <button id="lockBtn">锁定模块</button>
            <button id="resetBtn">重置</button>
        </div>
        
        <div class="modules">
            <div class="module locked" data-index="0">日常任务</div>
            <div class="module locked" data-index="1">Quest</div>
            <div class="module locked" data-index="2">mission_pass</div>
            <div class="module locked" data-index="3">邮票</div>
            <div class="module locked" data-index="4">login_bonus</div>
            <div class="module locked" data-index="5">好友系统</div>
            <div class="module locked" data-index="6">C活动</div>
            <div class="module locked" data-index="7">OOS 促销</div>
            <div class="module locked" data-index="8">推送开关奖励</div>
        </div>
        
        <div class="result">
            <strong>结果:</strong>
            <div id="resultText"></div>
        </div>
        
        <div class="error" id="errorMsg"></div>
    </div>

    <script>
        // 模块名称映射
        const MODULE_UNLOCK_FLAG_INDEX = { 
            'mission_infinite': 0, 
            'quest_slots': 1, 
            'mission_pass': 2, 
            'stamp_career': 3, 
            'login_bonus': 4, 
            'friends_infomanager': 5, 
            'c_processor': 6, 
            'oos_promotion': 7, 
            'broadcast_reward': 8 
        };
        
        // 模块索引到中文名称的映射
        const MODULE_INDEX_TO_NAME = {
            0: '日常任务',
            1: 'Quest',
            2: 'MP',
            3: '邮票',
            4: 'login bonus',
            5: '好友系统',
            6: 'C 活动',
            7: 'OOS 促销',
            8: '推送奖励'
        };

        class ModuleUnlockManager {
            constructor(initialState) {
                this._state = initialState;
                this.num_modules = 8 * this._state.length;
            }
            
            _get_bit_location(module_index) {
                if (!(0 <= module_index < this.num_modules)) {
                    throw new Error(`模块索引 ${module_index} 超出范围 (0-${this.num_modules - 1})。`);
                }
                
                const byte_index = Math.floor(module_index / 8);
                const bit_index = module_index % 8;
                return { byte_index, bit_index };
            }
            
            is_unlocked(module_index) {
                const { byte_index, bit_index } = this._get_bit_location(module_index);
                const mask = 1 << bit_index;
                return (this._state[byte_index] & mask) !== 0;
            }
            
            unlock(module_index) {
                const { byte_index, bit_index } = this._get_bit_location(module_index);
                const mask = 1 << bit_index;
                
                // 创建一个新的Uint8Array以修改值
                const state_array = new Uint8Array(this._state);
                state_array[byte_index] |= mask;
                
                this._state = state_array;
            }
            
            lock(module_index) {
                const { byte_index, bit_index } = this._get_bit_location(module_index);
                const mask = 1 << bit_index;
                
                // 创建一个新的Uint8Array以修改值
                const state_array = new Uint8Array(this._state);
                state_array[byte_index] &= ~mask;
                
                this._state = state_array;
            }
            
            state() {
                return Array.from(this._state).map(b => b.toString(16).padStart(2, '0')).join('');
            }
            
            to_hex_string() {
                return "b'" + Array.from(this._state).map(b => `\\x${b.toString(16).padStart(2, '0')}`).join('') + "'";
            }
            
            to_simple_hex_string() {
                return Array.from(this._state).map(b => `\\x${b.toString(16).padStart(2, '0')}`).join('');
            }
        }
        
        // 辅助函数：将字符串转换为字节数组
        function parse_byte_string(str) {
            // 移除可能存在的b'和'
            const cleanStr = str.replace(/^b'|'$/g, '');
            
            // 匹配所有\xXX格式的十六进制数
            const matches = cleanStr.match(/\\x[0-9a-fA-F]{2}/g);
            
            if (!matches) {
                throw new Error('无效的字节序列格式');
            }
            
            // 转换为Uint8Array
            const bytes = new Uint8Array(matches.map(match => parseInt(match.slice(2), 16)));
            return bytes;
        }
        
        // 页面元素
        const byteInput = document.getElementById('byteInput');
        const moduleIndex = document.getElementById('moduleIndex');
        const unlockBtn = document.getElementById('unlockBtn');
        const lockBtn = document.getElementById('lockBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultText = document.getElementById('resultText');
        const errorMsg = document.getElementById('errorMsg');
        const moduleElements = document.querySelectorAll('.module');
        
        let manager = null;
        
        // 初始化
        function init() {
            try {
                const initialBytes = parse_byte_string(byteInput.value);
                manager = new ModuleUnlockManager(initialBytes);
                
                // 更新模块显示
                update_module_display();
                
                // 显示初始状态
                resultText.textContent = `初始状态: ${manager.to_simple_hex_string()}`;
                errorMsg.textContent = '';
            } catch (error) {
                errorMsg.textContent = '错误: ' + error.message;
            }
        }
        
        // 更新模块显示
        function update_module_display() {
            moduleElements.forEach((element, index) => {
                const moduleIndex = index; // JavaScript索引从0开始
                if (manager.is_unlocked(moduleIndex)) {
                    element.classList.remove('locked');
                    element.classList.add('unlocked');
                    element.textContent = `${MODULE_INDEX_TO_NAME[moduleIndex]} (已解锁)`;
                } else {
                    element.classList.remove('unlocked');
                    element.classList.add('locked');
                    element.textContent = `${MODULE_INDEX_TO_NAME[moduleIndex]} (已锁定)`;
                }
            });
        }
        
        // 解锁按钮点击事件
        unlockBtn.addEventListener('click', () => {
            try {
                const index = parseInt(moduleIndex.value) - 1; // 转换为0-based索引
                manager.unlock(index);
                update_module_display();
                resultText.textContent = `解锁模块 ${index + 1} (${MODULE_INDEX_TO_NAME[index]}) 后: ${manager.to_simple_hex_string()}`;
                errorMsg.textContent = '';
            } catch (error) {
                errorMsg.textContent = '错误: ' + error.message;
            }
        });
        
        // 锁定按钮点击事件
        lockBtn.addEventListener('click', () => {
            try {
                const index = parseInt(moduleIndex.value) - 1; // 转换为0-based索引
                manager.lock(index);
                update_module_display();
                resultText.textContent = `锁定模块 ${index + 1} (${MODULE_INDEX_TO_NAME[index]}) 后: ${manager.to_simple_hex_string()}`;
                errorMsg.textContent = '';
            } catch (error) {
                errorMsg.textContent = '错误: ' + error.message;
            }
        });
        
        // 重置按钮点击事件
        resetBtn.addEventListener('click', init);
        
        // 模块点击事件
        moduleElements.forEach((element, index) => {
            element.addEventListener('click', () => {
                moduleIndex.value = index + 1;
            });
        });
        
        // 初始加载
        init();
    </script>
</body>
</html>